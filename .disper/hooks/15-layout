#!/bin/bash

set -eu

set_primary() {
	xrandr --output "$1" --primary
}

get_geometry() {
	xrandr|awk -v monitor="$1" '$1==monitor && $2=="connected" {print $0}'|sed -n 's/.*\<\([0-9]\+\)x\([0-9]\+\)+\([0-9]\+\)+\([0-9]\+\).*/\1 \2 \3 \4/p'
}

width() {
	get_geometry "$1"|awk '{print $1}'
}

height() {
	get_geometry "$1"|awk '{print $2}'
}

horiz_offset() {
	get_geometry "$1"|awk '{print $3}'
}

vert_offset() {
	get_geometry "$1"|awk '{print $4}'
}

is_connected() {
	display="$1"
	xrandr|awk -v monitor="$1" '$1==monitor && $2=="connected" {print "ok"}'|grep -qF "ok"
}

ordered() {
	displays=( "${@}" )
	echo "Display order: ${displays[*]}"

	connected_displays=()
	disconnected_displays=()

	for display in "${displays[@]}"; do
		if is_connected "$display"; then
			connected_displays+=( "$display" )
		else
			disconnected_displays+=( "$display" )
		fi
	done

	xrandr_opts=( )

	for display in "${disconnected_displays[@]}"; do
		xrandr_opts+=( --output "$display" --auto )
	done

	if [ ${#connected_displays[@]} -gt 0 ]; then
		prev_display="${connected_displays[0]}"	

		for display in "${connected_displays[@]:1}"; do
			xrandr_opts+=( --output "$display" --rotate normal --auto --right-of "${prev_display}" )
			prev_display="$display"
		done
	fi
	xrandr "${xrandr_opts[@]}"
}

if [ -r /sys/devices/virtual/dmi/id/product_name ] && grep -q '^MS-7C80$' /sys/devices/virtual/dmi/id/product_name; then
	echo "Running on desktop"
	ordered 'HDMI-1' 'DP-1'
	set_primary 'DP-1'
elif [ -r /sys/devices/virtual/dmi/id/product_name ] && grep -q '^21B5005YMX$' /sys/devices/virtual/dmi/id/product_name; then
	echo "Running on laptop"
	ordered 'DP-2' 'eDP-1' 'DP-3'
	set_primary 'DP-3'
elif is_connected "DP-0.1" && is_connected "DP-0.8" && is_connected "DP-4"; then
	echo "Recognized as $(hostname) in three-screen configuration with DP-0"
	xrandr_opts=(
		--output DP-0.1 --auto --pos 0x0 --rotate right  # Left monitor is rotated
		--output DP-0.8 --auto --pos 1440x500 --primary  # Adds vertical offset to center monitor
		--output DP-4   --auto --pos 4000x340            # Aligns bottom of laptop with bottom of center
	)
	xrandr "${xrandr_opts[@]}"
elif is_connected "DP-2.1" && is_connected "DP-2.8" && is_connected "DP-4"; then
	echo "Recognized as $(hostname) in three-screen configuration with DP-2"
	xrandr_opts=(
		--output DP-2.1 --auto --pos 0x0 --rotate right  # Left monitor is rotated
		--output DP-2.8 --auto --pos 1440x500 --primary  # Adds vertical offset to center monitor
		--output DP-4   --auto --pos 4000x340            # Aligns bottom of laptop with bottom of center
	)
	xrandr "${xrandr_opts[@]}"
else
	echo "Unrecognized setup. Falling back to default layout"
	mapfile -t alldisplays < <(xrandr|awk '$2=="disconnected" || $2=="connected" {print $1}')
	ordered "${alldisplays[@]}"
fi

